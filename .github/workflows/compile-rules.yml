name: Compile MRS Rule Sets

on:
  push:
    branches:
      - main
    paths:
      - 'rules/**'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # --- 这是最关键的修改 ---
      - name: Download Mihomo Core (Stable Version)
        run: |
          # 我们不再使用API查询，而是直接下载一个可靠的正式版
          wget -O mihomo.gz "https://github.com/MetaCubeX/mihomo/releases/download/v1.18.1/mihomo-linux-amd64-v1.18.1.gz"
          gunzip mihomo.gz
          chmod +x mihomo
          echo "Mihomo core (Stable Version) downloaded and ready."

      - name: Create compiled rules directory
        run: mkdir -p compiled_rules

      - name: Compile all rule files
        run: |
          for file in rules/*; do
            if [ -f "$file" ]; then
              filename=$(basename -- "$file")
              filename_no_ext="${filename%.*}"
              
              echo "Compiling $file -> compiled_rules/${filename_no_ext}.mrs"
              ./mihomo rule-set compile "$file" -o "compiled_rules/${filename_no_ext}.mrs"
            fi
          done

      - name: Commit and push compiled files
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: Auto-compile MRS rule sets"
          file_pattern: 'compiled_rules/*.mrs'
          commit_user_name: "GitHub Actions Bot"
          commit_user_email: "actions@github.com"
          commit_author: "GitHub Actions Bot <actions@github.com>"
