name: Compile MRS Rule Sets

on:
  push:
    branches:
      - main
    paths:
      - 'rules/**/*.txt'
      - 'rules/**/*.yaml'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    # --- FIX: Add permissions block ---
    # This grants the job permission to write back to the repository
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download Mihomo Core
        run: |
          wget -O mihomo.gz "https://github.com/MetaCubeX/mihomo/releases/download/v1.18.1/mihomo-linux-amd64-v1.18.1.gz"
          gunzip mihomo.gz
          chmod +x mihomo

      - name: Create a minimal dummy config file
        run: |
          cat > dummy-config.yaml <<'EOF'
          mixed-port: 7890
          allow-lan: false
          mode: rule
          log-level: info
          EOF
          echo "dummy-config.yaml content:"
          cat dummy-config.yaml

      - name: Show mihomo info / help (diagnostic)
        run: |
          ./mihomo --version || true
          # --- FIX: Add timeout to help commands to prevent hanging ---
          timeout 30s ./mihomo convert-ruleset --help || timeout 30s ./mihomo --help || true

      - name: Convert .txt and .yaml files to .mrs (with timeout + diagnostics)
        run: |
          set -euo pipefail
          shopt -s globstar nullglob

          # collect files
          files=(rules/**/*.{txt,yaml})
          if [ ${#files[@]} -eq 0 ]; then
            echo "No rule files found under rules/ â€” nothing to do."
            exit 0
          fi

          # Do a quick single-file dry-run on the first file to detect hangs/errors early
          first="${files[0]}"
          echo "Dry-run converting single file (timeout 60s) : $first"
          
          # --- FIX: Correct dry-run logic to match main loop ---
          if [[ "$first" == *"-ipcidr"* ]]; then
            DRY_RUN_TYPE="ipcidr"
          else
            DRY_RUN_TYPE="domain"
          fi
          
          dry_run_ext="${first##*.}"
          if [[ "$dry_run_ext" == "yaml" ]]; then
            DRY_RUN_FORMAT="yaml"
          else
            DRY_RUN_FORMAT="text"
          fi

          mkdir -p /tmp/mihomo_test_out
          if ! timeout 60s ./mihomo convert-ruleset "$DRY_RUN_TYPE" "$DRY_RUN_FORMAT" "$first" "/tmp/mihomo_test_out/$(basename "$first").mrs" -c dummy-config.yaml; then
            echo "Dry-run failed or timed out. Printing sample logs and aborting before bulk run."
            ps aux | grep mihomo || true
            ls -la /tmp || true
            exit 1
          fi
          echo "Dry-run succeeded, proceeding to bulk conversion..."
          # --- End of dry-run fix ---

          for file in "${files[@]}"; do
            if [[ "$file" == *"-ipcidr"* ]]; then
              TYPE="ipcidr"
            else
              TYPE="domain"
            fi

            ext="${file##*.}"
            if [[ "$ext" == "yaml" ]]; then
              FORMAT="yaml"
            else
              FORMAT="text"
            fi

            relative_path="${file#rules/}"
            parent_dir=$(dirname "$relative_path")
            target_dir="compiled_rules/$parent_dir"
            filename=$(basename "$relative_path")
            filename_no_ext="${filename%.*}"
            output_file="$target_dir/$filename_no_ext.mrs"

            mkdir -p "$target_dir"
            echo "Converting '$file' -> '$output_file' (type=$TYPE format=$FORMAT)"

            # timeout prevents long-running server mode from hanging the job
            if ! timeout 120s ./mihomo convert-ruleset "$TYPE" "$FORMAT" "$file" "$output_file" -c dummy-config.yaml; then
              echo "Conversion failed or timed out for: $file"
              exit 1
            fi
          done

      - name: Commit and push compiled files
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: Auto-compile MRS rule sets"
          
          # --- IMPROVEMENT: Use the directory path ---
          # This will add all new, modified, or deleted files within the compiled_rules/ directory
          file_pattern: 'compiled_rules/'
          
          # --- IMPROVEMENT: Add commit user details ---
          commit_user_name: github-actions[bot]
          commit_user_email: 41898282+github-actions[bot]@users.noreply.github.com

