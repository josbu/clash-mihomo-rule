name: Compile MRS Rule Sets

on:
  push:
    branches:
      - main
    paths:
      - 'rules/**'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # --- 这是新增的修正步骤 ---
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Download Mihomo Core
        run: |
          MIHOMO_URL=$(curl -s "https://api.github.com/repos/MetaCubeX/mihomo/releases" | jq -r '.[0].assets[] | select(.name | contains("linux-amd64-alpha")) | .browser_download_url')
          wget -O mihomo.gz "$MIHOMO_URL"
          gunzip mihomo.gz
          chmod +x mihomo
          echo "Mihomo core downloaded and ready."

      - name: Create compiled rules directory
        run: mkdir -p compiled_rules

      - name: Compile all rule files
        run: |
          for file in rules/*; do
            if [ -f "$file" ]; then
              filename=$(basename -- "$file")
              filename_no_ext="${filename%.*}"
              
              echo "Compiling $file -> compiled_rules/${filename_no_ext}.mrs"
              ./mihomo rule-set compile "$file" -o "compiled_rules/${filename_no_ext}.mrs"
            fi
          done

      - name: Commit and push compiled files
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: Auto-compile MRS rule sets"
          file_pattern: 'compiled_rules/*.mrs'
          commit_user_name: "GitHub Actions Bot"
          commit_user_email: "actions@github.com"
          commit_author: "GitHub Actions Bot <actions@github.com>"
